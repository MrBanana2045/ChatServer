<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat Server</title>
<style>
#group {
    position: fixed;
    top: 0;
    left: 0;
    width: 120px;
    height: 100%;
    background: #222;
    color: #fff;
    overflow-y: auto;
    padding: 10px;
    box-shadow: 2px 0 5px rgba(0,0,0,0.5);
    z-index: 1000;
}
#chatPanel {
    position: fixed;
    top: 0;
    left: 140px;
    width: calc(100% - 100px);
    height: 100%;
    background: #222;
    color: #fff;
    overflow-y: auto;
    padding: 10px;
    box-shadow: -2px 0 5px rgba(0,0,0,0.5);
    z-index: 999;
}
#messages {
    height: calc(100% - 130px);
    overflow-y: auto;
    margin-top: 10px;
    padding-bottom: 80px;
}
#messageForm {
    position: fixed;
    bottom: 0;
    left: 140px;
    right: 0;
    background: #151515;
    padding: 10px;
    display: flex;
    z-index: 1000;
}
#messageForm input[type='text'] {
    flex: 1;
    padding: 5px;
    outline: none;
    background: #222;
    border: none;
    border-bottom: 2px solid #555;
    color:white;
}
#messageForm input[type='submit'] {
    padding: 5px 10px;
    background: none;
    border: none;
    border-bottom: 2px solid #555;
    font-size: 20px;
    color: #555;
}
.group-item {
    padding: 10px;
    margin: 5px 0;
    background: #333;
    border-radius: 4px;
    cursor: pointer;
}
.group-item:hover {
    background: #444;
}
.group-item.active {
    background: #555;
}

::-webkit-scrollbar {
  width: 10px;
}

::-webkit-scrollbar-track {
  background: #aaa; 
}
 
::-webkit-scrollbar-thumb {
  background: #222; 
}

#userPanel {
    position: fixed;
    top: 0;
    right: -400px;
    width: 300px;
    height: 100%;
    background: #222;
    color: #fff;
    overflow-y: auto;
    padding: 10px;
    box-shadow: -2px 0 5px rgba(0,0,0,0.5);
    z-index: 1001;
    transition: right 0.3s ease;
}

#userPanel.open {
    right: 0;
}

#userPanel h3 {
    margin-top: 0;
    padding-bottom: 10px;
    border-bottom: 1px solid #444;
}

#userPanel .close-btn {
    position: absolute;
    top: 10px;
    left: 10px;
    font-size: 20px;
    cursor: pointer;
    background: none;
    border: none;
    color: #fff;
}

#userPanel .ip-list {
    margin-top: 20px;
}

#userPanel .ip-item {
    padding: 8px;
    margin: 5px 0;
    background: #333;
    border-radius: 4px;
    display: flex;
    justify-content: space-between;
}

#userPanel .ip-item .timestamp {
    color: #aaa;
    font-size: 12px;
}

#usr {
    cursor: pointer;
}
#showRip{
    position: fixed;
    bottom: 0;
    left: 140px;
    right: 0;
    height:100px;
    border-radius: 20px;
    background:#151515;
    padding: 10px;
    display: none;
}

#rip{
  background:#222;
  border-radius: 20px;
  padding: 10px;
  font-weight: 900;
  border-left: 2px solid #fff;
  display: flex;
}
</style>
</head>
<body>
    <code>
<div id="group">
    <h3>Servers</h3><p id="add" style="float:right; margin-top: -38px; font-size: 20px;">✚</p>
    <div id="groupList"></div>
</div>
<div id="chatPanel">
    <div style="background: #151515; margin-top:-10px; height:40px; margin-left:-8px; padding:10px;">
        <h3 id="user"></h3> 
        <p id='usr' style="color:#fff; text-align: right; margin-right:50px; margin-top:-38px; font-size: 20px; cursor: pointer;">☰</p>
    </div>
    <div id="messages">Loading Message ...</div>
    <div id="showRip">
            <div id="rip"></div>
        </div>
    <form id="messageForm" method="POST" action="save.php">
        <input type="hidden" name="reply" id="replyInput" />
        <input type="hidden" name="group" id="currentGroup" value="" />
        <input type="text" name="msg" placeholder="Message ..." required />
        <input type="submit" value="➤" />
    </form>
</div>

<div id="userPanel">
    <button class="close-btn" onclick="toggleUserPanel()">✕</button>
    <h3 style="margin-left:40px; margin-top: 10px;" id="usrs"></h3>
    <div id="ipList" class="ip-list">
        <p>Loading users...</p>
    </div>
</div>

<script>
let currentGroup = null;
let userPanelOpen = false;

function loadGroups() {
    fetch('load.php')
        .then(response => response.json())
        .then(data => {
            const groupList = document.getElementById('groupList');
            groupList.innerHTML = '';
            
            data.groupName.forEach(groupName => {
                const groupItem = document.createElement('div');
                groupItem.className = 'group-item';
                groupItem.textContent = groupName;
                
                groupItem.addEventListener('click', function() {
                    document.querySelectorAll('.group-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    
                    this.classList.add('active');
                    currentGroup = groupName;
                    document.getElementById('currentGroup').value = groupName;
                    loadMessages();
                });
                
                groupList.appendChild(groupItem);
            });
            
            if (data.groupName.length > 0 && currentGroup === null) {
                currentGroup = data.groupName[0];
                document.getElementById('currentGroup').value = currentGroup;
                document.querySelector('.group-item').classList.add('active');
                loadMessages();
            }
        });
}

function loadMessages() {
    if (!currentGroup) return;

    fetch(`load.php?group=${encodeURIComponent(currentGroup)}`)
        .then(response => response.json())
        .then(data => {
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML = '';
            document.getElementById('usrs').innerText = 'Members ' + data.ip;
            document.getElementById('user').innerText = 'Server ' + data.ip;

            data.messages.forEach(msg => {
                const isReplied = msg.includes('┏╼╼┫') || msg.includes('│') || msg.includes('┗╾╾┫');
                const isJoin = msg.includes('*');

                const messageEl = document.createElement('div');
                messageEl.className = 'message';
                messageEl.style.display = 'flex';
                messageEl.style.alignItems = 'center';


                const messageText = document.createElement('div');
                messageText.innerHTML = msg;
                messageText.style.flex = '1';

                const replyBtn = document.createElement('button');
                replyBtn.textContent = '↺';

                replyBtn.style.background = 'none';
                replyBtn.style.color = 'white';
                replyBtn.style.fontWeight = '900';
                replyBtn.style.border = 'none';
                replyBtn.style.borderLeft = '2px solid white';
                replyBtn.style.cursor = 'pointer';
                replyBtn.style.marginRight = '50px';
                replyBtn.style.marginBottom = '5px';
                messageEl.appendChild(messageText);
                messageEl.appendChild(replyBtn);

                replyBtn.onclick = () => {
                    document.getElementById('replyInput').value = msg;
                    document.querySelectorAll('.message button').forEach(btn => {
                        btn.disabled = false;
                        btn.style.display = 'inline-block';
                    });
                    replyBtn.disabled = true;
                    replyBtn.style.display = 'none';
                    showReplyPreview(msg);
                };

                if (isReplied || isJoin) {
                    replyBtn.style.display = 'none';
                }

                messagesDiv.appendChild(messageEl);
            });
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        });
}

function toggleUserPanel() {
    const userPanel = document.getElementById('userPanel');
    userPanelOpen = !userPanelOpen;
    
    if (userPanelOpen) {
        userPanel.classList.add('open');
    } else {
        userPanel.classList.remove('open');
    }
}

let previousUsers = [];

function loadUsers() {
    if (!currentGroup) return;

    fetch(`user.php?group=${encodeURIComponent(currentGroup)}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: `group=${encodeURIComponent(currentGroup)}`
    })
    .then(response => response.json())
    .then(data => {
        const ipList = document.getElementById('ipList');
        ipList.innerHTML = '';
        const currentUsers = [];

        if (data.users && data.users.length > 0) {
            data.users.forEach(user => {
                currentUsers.push(user.ip);
                const ipItem = document.createElement('div');
                ipItem.className = 'ip-item';
                const ipText = document.createElement('span');
                ipText.textContent = user.ip;
                const timestamp = document.createElement('span');
                timestamp.className = 'timestamp';
                timestamp.textContent = user.last_seen;
                ipItem.appendChild(ipText);
                ipItem.appendChild(timestamp);
                ipList.appendChild(ipItem);
            });

            const newUsers = currentUsers.filter(ip => !previousUsers.includes(ip));
            newUsers.forEach(newIp => {
                fetch(`save.php`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: `user=${encodeURIComponent(newIp)}&group=${encodeURIComponent(currentGroup)}`
                }).then(res => res.json())
            });
        } else {
            ipList.innerHTML = '<p>No users found.</p>';
        }
        previousUsers = currentUsers;
    });
}

setInterval(loadMessages, 2000);
setInterval(loadGroups, 2000);
setInterval(loadUsers, 2000);

document.getElementById('messageForm').addEventListener('submit', function(e) {
    e.preventDefault();
    if (!currentGroup) return;
    
    const formData = new FormData(this);
    const messageInput = formData.get('message');

    fetch('save.php', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        document.getElementById('showRip').style.display = 'none';
        location.reload();
        return response.json();
    })
    .then(data => {
        loadMessages();
        loadUsers();
    })
    .catch(error => {
        console.error('There was a problem with the fetch operation:', error);
    });
});

function showReplyPreview(msg) {
    const ripDiv = document.getElementById('rip');
    ripDiv.innerHTML = '';

    const closeBtn = document.createElement('p');
    closeBtn.textContent = '✕';
    closeBtn.style.fontWeight = '900';
    closeBtn.style.marginTop = '-5px';
    closeBtn.style.marginRight = '10px';
    closeBtn.style.cursor = 'pointer';
    closeBtn.onclick = () => {
        document.getElementById('showRip').style.display = 'none';
        location.reload();
    };
    ripDiv.appendChild(closeBtn);

    const msgPara = document.createElement('p');
    msgPara.textContent = msg;
    ripDiv.appendChild(msgPara);

    document.getElementById('showRip').style.display = 'block';
}

document.getElementById('usr').addEventListener('click', toggleUserPanel);
document.getElementById('add').addEventListener('click', function(e){
    fetch('server.php?group=${encodeURIComponent(currentGroup)}', {
        method: 'POST'
    })
    .then(response => response.text())
});
loadGroups();
</script>
</code>
</body>
</html>